language: node_js
node_js:
  - 10.4.0
dist: trusty
sudo: false
# addons:
#   ssh_known_hosts:
#     -
before_install:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" $REGISTRY_URL --password-stdin
  # - echo -e "Host $host\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
  # - openssl aes-256-cbc -K $encrypted_07f88c26126b_key -iv $encrypted_07f88c26126b_iv
  #   -in .travis/deploy_rsa.enc -out .travis/id_rsa -d
  # - eval "$(ssh-agent -s)"
  # - cp .travis/id_rsa ~/.ssh/id_rsa
  # - chmod 600 ~/.ssh/id_rsa
  # - ssh-add ~/.ssh/id_rsa

script:
  - docker pull $REGISTRY_URL/workspace/client || true
  - docker pull $REGISTRY_URL/workspace/backend || true
  - docker pull $REGISTRY_URL/workspace/nginx || true

  - docker build --cache-from $REGISTRY_URL/workspace/client -t $REGISTRY_URL/workspace/client ./client
  - docker build --cache-from $REGISTRY_URL/workspace/backend -t $REGISTRY_URL/workspace/backend ./server
  - docker build --cache-from $REGISTRY_URL/workspace/nginx -t $REGISTRY_URL/workspace/nginx ./nginx
  - docker save $REGISTRY_URL/workspace/client $REGISTRY_URL/workspace/backend $REGISTRY_URL/workspace/nginx | gzip -2 > "$HOME/docker/docker_images.tar.gz"

deploy:
  - provider: script
    skip_cleanup: true
    script: env HOST=$host .travis/deploy-staging.sh
    on:
      branch:
        - ci
        - staging
  - provider: script
    skip_cleanup: true
    script: env HOST=$host .travis/deploy-prod.sh
    on:
      branch:
        - master
